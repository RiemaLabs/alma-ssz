From 571a8a27b64b9e64ac9943ddb933040b695b2ba1 Mon Sep 17 00:00:00 2001
From: Chris Berry <bez625@gmail.com>
Date: Fri, 8 Aug 2025 18:53:30 +0100
Subject: [PATCH] Correct validation on bitlist Marshalling (#184)

* Add handling for Bitlist Marshalling.

* Regenerate code generation.
---
 encode.go                     | 20 ++++++++++++++++++++
 spectests/structs_encoding.go |  4 ++--
 sszgen/generator/validate.go  | 21 ++++++++++++++++++++-
 3 files changed, 42 insertions(+), 3 deletions(-)

diff --git a/encode.go b/encode.go
index db27e60..8902946 100644
--- a/encode.go
+++ b/encode.go
@@ -225,6 +225,26 @@ func ValidateBitlist(buf []byte, bitLimit uint64) error {
 	return nil
 }
 
+// BitlistLen provides the bitlist length of a byte array
+func BitlistLen(b []byte) uint64 {
+	if len(b) == 0 {
+		return 0
+	}
+	// The most significant bit is present in the last byte in the array.
+	last := b[len(b)-1]
+
+	// Determine the position of the most significant bit.
+	msb := bits.Len8(last)
+	if msb == 0 {
+		return 0
+	}
+
+	// The absolute position of the most significant bit will be the number of
+	// bits in the preceding bytes plus the position of the most significant
+	// bit. Subtract this value by 1 to determine the length of the bitlist.
+	return uint64(8*(len(b)-1) + msb - 1)
+}
+
 // DecodeDynamicLength decodes the length from the dynamic input
 func DecodeDynamicLength(buf []byte, maxSize uint64) (uint64, error) {
 	if len(buf) == 0 {
diff --git a/spectests/structs_encoding.go b/spectests/structs_encoding.go
index 579f0f6..8790c87 100644
--- a/spectests/structs_encoding.go
+++ b/spectests/structs_encoding.go
@@ -355,7 +355,7 @@ func (a *Attestation) MarshalSSZTo(buf []byte) (dst []byte, err error) {
 	dst = append(dst, a.Signature[:]...)
 
 	// Field (0) 'AggregationBits'
-	if size := uint64(len(a.AggregationBits)); size > 2048 {
+	if size := ssz.BitlistLen(a.AggregationBits); size > 2048 {
 		err = ssz.ErrBytesLengthFn("Attestation.AggregationBits", size, 2048)
 		return
 	}
@@ -940,7 +940,7 @@ func (p *PendingAttestation) MarshalSSZTo(buf []byte) (dst []byte, err error) {
 	dst = ssz.MarshalValue(dst, p.ProposerIndex)
 
 	// Field (0) 'AggregationBits'
-	if size := uint64(len(p.AggregationBits)); size > 2048 {
+	if size := ssz.BitlistLen(p.AggregationBits); size > 2048 {
 		err = ssz.ErrBytesLengthFn("PendingAttestation.AggregationBits", size, 2048)
 		return
 	}
diff --git a/sszgen/generator/validate.go b/sszgen/generator/validate.go
index 33247b8..f91b091 100644
--- a/sszgen/generator/validate.go
+++ b/sszgen/generator/validate.go
@@ -19,10 +19,29 @@ func validateBytesArray(name string, size Size, fixed bool) string {
 	})
 }
 
+func validateBitListArray(name string, size Size, fixed bool) string {
+	// for variable size values, we want to ensure it doesn't exceed max size bound
+	cmp := ">"
+	if fixed {
+		cmp = "!="
+	}
+
+	tmpl := `if size := ssz.BitlistLen(::.{{.name}}); size {{.cmp}} {{.size}} {
+			err = ssz.ErrBytesLengthFn("--.{{.name}}", size, {{.size}})
+			return
+		}
+		`
+	return execTmpl(tmpl, map[string]interface{}{
+		"cmp":  cmp,
+		"name": name,
+		"size": size,
+	})
+}
+
 func (v *Value) validate() string {
 	switch obj := v.typ.(type) {
 	case *BitList:
-		return validateBytesArray(v.name, NewSizeNum(obj.Size), false)
+		return validateBitListArray(v.name, NewSizeNum(obj.Size), false)
 	case *Bytes:
 		if obj.IsList {
 			// for lists of bytes, we need to validate the size of the buffer
-- 
2.50.1

